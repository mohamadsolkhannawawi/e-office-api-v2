// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator prismabox {
  provider                    = "prismabox"
  output                      = "../src/generated/prismabox"
  typeboxImportVariableName   = "t"
  typeboxImportDependencyName = "elysia"
  additionalProperties        = true
  inputModel                  = true
}

/* ===================== AUTH MODELS ===================== */

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([userId, providerId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

/* ===================== RBAC ===================== */

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  users       UserRole[]
  permissions RolePermission[]
  LetterInstance LetterInstance[]

  @@map("role")
}

model Permission {
  id       String           @id @default(cuid())
  resource String
  action   String
  roles    RolePermission[]

  @@unique([resource, action])
  @@map("permission")
}

model UserRole {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String
  role   Role   @relation(fields: [roleId], references: [id])
  roleId String

  @@unique([userId, roleId])
  @@map("user_role")
}

model RolePermission {
  id           String     @id @default(cuid())
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  @@unique([roleId, permissionId])
  @@map("role_permission")
}

/* ===================== USER ===================== */

model User {
  id String @id @default(cuid())

  name  String
  email String @unique

  emailVerified Boolean  @default(false)
  image         String?
  isAnonymous   Boolean? @default(false)

  mahasiswa Mahasiswa?
  pegawai   Pegawai?

  userRole       UserRole[]
  sessions       Session[]
  accounts       Account[]
  LetterInstance LetterInstance[]
  LetterHistory  LetterHistory[]
  UserSignature  UserSignature[]
  Notification   Notification[] // ðŸ”´ TAMBAHAN

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("user")
}

model Mahasiswa {
  id  String @id @default(cuid())
  nim String

  tahunMasuk   String
  noHp         String
  alamat       String?
  tempatLahir  String?
  tanggalLahir DateTime?
  semester     Int?
  ipk          Float?
  ips          Float?

  userId         String        @unique
  user           User          @relation(fields: [userId], references: [id])
  departemenId   String
  departemen     Departemen?   @relation(fields: [departemenId], references: [id])
  programStudiId String
  programStudi   ProgramStudi? @relation(fields: [programStudiId], references: [id])

  @@map("mahasiswa")
}

model Pegawai {
  id      String  @id @default(cuid())
  nip     String
  jabatan String
  noHp    String?

  userId         String        @unique
  user           User          @relation(fields: [userId], references: [id])
  departemenId   String
  departemen     Departemen?   @relation(fields: [departemenId], references: [id])
  programStudiId String
  programStudi   ProgramStudi? @relation(fields: [programStudiId], references: [id])

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("pegawai")
}

/* ===================== MASTER ===================== */

model Departemen {
  id   String @id @default(cuid())
  name String
  code String @unique

  programStudi ProgramStudi[]
  pegawai      Pegawai[]
  mahasiswa    Mahasiswa[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("departemen")
}

model ProgramStudi {
  id String @id @default(cuid())
  name String
  code String @unique

  departemenId String
  departemen   Departemen @relation(fields: [departemenId], references: [id])

  pegawai   Pegawai[]
  mahasiswa Mahasiswa[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("program_studi")
}

/* ===================== LETTER ===================== */

model Attachment {
  id String @id @default(cuid())

  domain         String
  filename       String
  fileSize       Int?
  mimeType       String?
  category       String?
  attachmentType String?

  letterInstanceId String?
  letterInstance   LetterInstance? @relation(fields: [letterInstanceId], references: [id], onDelete: Cascade)

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("attachment")
}

model LetterType {
  id          String  @id @default(cuid())
  name        String
  description String?

  templates      LetterTemplate[]
  letterInstance LetterInstance[]

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?

  @@map("letter_type")
}

enum TemplateEngine {
  HANDLEBARS
  RAW
}

model LetterTemplate {
  id String @id @default(cuid())

  versionName      String
  schemaDefinition Json
  formFields       Json

  // ðŸ”´ TAMBAHAN
  templateEngine TemplateEngine @default(HANDLEBARS)

  letterTypeId String
  LetterType   LetterType @relation(fields: [letterTypeId], references: [id])

  @@map("letter_template")
}

enum LetterStatus {
  DRAFT
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  REVISION
}

model LetterInstance {
  id String @id @default(cuid())

  schema          Json
  values          Json
  status          LetterStatus @default(PENDING)
  currentStep     Int?
  scholarshipName String?
  letterNumber    String?

  currentRoleId String?        // ðŸ”´ TAMBAHAN
  currentRole   Role? @relation(fields: [currentRoleId], references: [id]) // ðŸ”´ TAMBAHAN
  publishedAt    DateTime?     // ðŸ”´ TAMBAHAN

  history  LetterHistory[]
  versions LetterVersion[]

  letterTypeId String
  letterType   LetterType @relation(fields: [letterTypeId], references: [id])
  createdById  String
  createdBy    User       @relation(fields: [createdById], references: [id])

  attachments Attachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("letter_instance")
}

model LetterHistory {
  id               String   @id @default(cuid())
  letterInstanceId String
  letterInstance   LetterInstance @relation(fields: [letterInstanceId], references: [id], onDelete: Cascade)
  
  action  String
  note    String?
  actorId String
  actor   User @relation(fields: [actorId], references: [id])
  status  String?

  createdAt DateTime @default(now())

  @@map("letter_history")
}

model LetterVersion {
  id               String   @id @default(cuid())
  letterInstanceId String
  letterInstance   LetterInstance @relation(fields: [letterInstanceId], references: [id], onDelete: Cascade)
  
  fileUrl       String
  versionNumber Int
  
  createdAt DateTime @default(now())
  
  @@map("letter_version")
}

model UserSignature {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  url           String
  isDefault     Boolean  @default(false)
  signatureType String   // ðŸ”´ TAMBAHAN
  checksum      String?  // ðŸ”´ TAMBAHAN
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("user_signature")
}

/* ===================== NOTIFICATION ===================== */

// ðŸ”´ TAMBAHAN
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  entityId  String?

  createdAt DateTime @default(now())

  @@map("notification")
}